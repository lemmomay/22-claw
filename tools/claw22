#!/usr/bin/env bash
# claw22 - OpenClaw ç®¡ç†å·¥å…·
# ä½œè€…: 22 & 11
# ç‰ˆæœ¬: 2.0.0

set -euo pipefail

APP="openclaw"
CFG="${HOME}/.openclaw/openclaw.json"
LOG_HINT="journalctl -u openclaw -n 100 --no-pager"
CLAW_CMD="${CLAW_CMD:-openclaw}"

# é¢œè‰²å‡½æ•°
red(){ printf "\033[31m%s\033[0m\n" "$*"; }
green(){ printf "\033[32m%s\033[0m\n" "$*"; }
yellow(){ printf "\033[33m%s\033[0m\n" "$*"; }
blue(){ printf "\033[36m%s\033[0m\n" "$*"; }
cyan(){ printf "\033[96m%s\033[0m\n" "$*"; }
bold(){ printf "\033[1m%s\033[0m\n" "$*"; }
dim(){ printf "\033[2m%s\033[0m\n" "$*"; }

press_enter(){ read -r -p "$(dim 'å›è½¦ç»§ç»­...')" _; }
has_cmd(){ command -v "$1" >/dev/null 2>&1; }

# æ£€æµ‹ Gateway è¿è¡ŒçŠ¶æ€
is_gateway_running() {
  if has_cmd "$CLAW_CMD"; then
    local status_output
    status_output="$("$CLAW_CMD" gateway status 2>&1 || true)"
    if echo "$status_output" | grep -qE 'Runtime: running|state active|RPC probe: ok'; then
      return 0
    fi
  fi
  return 1
}

# è·å– Gateway ç«¯å£
get_gateway_port() {
  local p=""
  if [[ -f "$CFG" ]] && has_cmd jq; then
    p="$(jq -r '.gateway.port // empty' "$CFG" 2>/dev/null || true)"
  fi
  echo "${p:-32189}"
}

# è·å–å½“å‰æ¨¡å‹
get_current_model() {
  if [[ -f "$CFG" ]] && has_cmd jq; then
    jq -r '.agents.defaults.model.primary // "æœªé…ç½®"' "$CFG" 2>/dev/null || echo "æœªçŸ¥"
  else
    echo "æœªçŸ¥"
  fi
}

# æ˜¾ç¤ºå¤´éƒ¨ï¼ˆå¸¦çŠ¶æ€æŒ‡ç¤ºç¯ï¼‰
show_header() {
  clear || true
  
  # ASCII Art Logo
  cyan "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  cyan "â•‘                                        â•‘"
  cyan "â•‘        ğŸŒ¸  claw22 ç®¡ç†é¢æ¿  ğŸŒ¸        â•‘"
  cyan "â•‘                                        â•‘"
  cyan "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo
  
  # çŠ¶æ€æŒ‡ç¤ºç¯
  printf "  çŠ¶æ€: "
  if is_gateway_running; then
    printf "\033[32mâ—\033[0m "
    green "è¿è¡Œä¸­ (RUNNING)"
  else
    printf "\033[31mâ—\033[0m "
    red "å·²åœæ­¢ (STOPPED)"
  fi
  
  echo
  dim "  æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
  dim "  ç«¯å£: $(get_gateway_port)"
  dim "  æ¨¡å‹: $(get_current_model)"
  echo
  cyan "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo
}

# OpenClaw çŠ¶æ€
oc_status() {
  bold ">>> OpenClaw Gateway çŠ¶æ€"
  echo
  if has_cmd "$CLAW_CMD"; then
    "$CLAW_CMD" gateway status 2>&1 || true
  else
    red "æœªæ‰¾åˆ°å‘½ä»¤: $CLAW_CMD"
  fi
  echo
  bold ">>> ç›¸å…³è¿›ç¨‹"
  ps -ef | grep -E 'openclaw|openclaw-gateway|node.*openclaw' | grep -v grep || dim "æ— ç›¸å…³è¿›ç¨‹"
}

# å¯åŠ¨/åœæ­¢/é‡å¯
oc_start() {
  yellow "âš¡ å¯åŠ¨ OpenClaw Gateway..."
  "$CLAW_CMD" gateway start || true
  sleep 2
  oc_status
}

oc_stop() {
  yellow "â¸ï¸  åœæ­¢ OpenClaw Gateway..."
  "$CLAW_CMD" gateway stop || true
  sleep 1
  oc_status
}

oc_restart() {
  yellow "ğŸ”„ é‡å¯ OpenClaw Gateway..."
  "$CLAW_CMD" gateway restart || true
  sleep 2
  oc_status
}

# æ¸…ç†å¡ä½çš„è¿›ç¨‹
kill_stuck_procs() {
  yellow "ğŸ§¹ æ¸…ç†å¯èƒ½å¡ä½çš„è¿›ç¨‹..."
  pkill -f 'openclaw-gateway' 2>/dev/null || true
  pkill -f 'node.*openclaw' 2>/dev/null || true
  sleep 1
  green "âœ“ è¿›ç¨‹æ¸…ç†å®Œæˆ"
}

# æŸ¥æ‰¾ç½‘å…³ç«¯å£
find_gateway_port() {
  local p=""
  if [[ -f "$CFG" ]] && has_cmd jq; then
    p="$(jq -r '.gateway.port // empty' "$CFG" 2>/dev/null || true)"
  fi
  echo "${p:-32189}"
}

# é‡Šæ”¾ç«¯å£å ç”¨
free_gateway_port_if_needed() {
  local port
  port="$(find_gateway_port)"
  yellow "ğŸ” æ£€æŸ¥ç½‘å…³ç«¯å£: $port"
  if has_cmd lsof; then
    local pids
    pids="$(lsof -t -iTCP:"$port" -sTCP:LISTEN 2>/dev/null || true)"
    if [[ -n "${pids}" ]]; then
      yellow "âš ï¸  ç«¯å£ $port è¢«å ç”¨ï¼Œæ¸…ç† PID: $pids"
      kill -9 $pids 2>/dev/null || true
      sleep 1
      green "âœ“ ç«¯å£å·²é‡Šæ”¾"
    else
      green "âœ“ ç«¯å£ $port æ­£å¸¸"
    fi
  else
    yellow "âš ï¸  æœªå®‰è£… lsofï¼Œè·³è¿‡ç«¯å£æ£€æŸ¥"
  fi
}

# å¼ºåˆ¶é‡å¯
gateway_force_restart() {
  bold "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  bold "â•‘        ğŸ”§ å¼ºåˆ¶é‡å¯ Gateway ğŸ”§         â•‘"
  bold "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo
  kill_stuck_procs
  free_gateway_port_if_needed
  yellow "âš¡ å¯åŠ¨ Gateway..."
  "$CLAW_CMD" gateway start || true
  sleep 2
  oc_status
}

# ä¸€é”®æ€¥æ•‘
gateway_rescue() {
  bold "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  bold "â•‘        ğŸš‘ ä¸€é”®æ€¥æ•‘ä¿®å¤ ğŸš‘             â•‘"
  bold "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo
  
  yellow "1ï¸âƒ£  åœæ­¢æœåŠ¡..."
  "$CLAW_CMD" gateway stop 2>/dev/null || true
  sleep 1
  
  yellow "2ï¸âƒ£  æ¸…ç†è¿›ç¨‹..."
  kill_stuck_procs
  
  yellow "3ï¸âƒ£  é‡Šæ”¾ç«¯å£..."
  free_gateway_port_if_needed
  
  yellow "4ï¸âƒ£  å¯åŠ¨æœåŠ¡..."
  "$CLAW_CMD" gateway start || true
  sleep 2
  
  yellow "5ï¸âƒ£  éªŒè¯çŠ¶æ€..."
  oc_status
  
  green "âœ“ æ€¥æ•‘å®Œæˆï¼"
}

# æŸ¥çœ‹æ—¥å¿—
show_logs() {
  bold ">>> æœ€è¿‘ 100 è¡Œæ—¥å¿—"
  echo
  if has_cmd journalctl; then
    journalctl -u openclaw -n 100 --no-pager 2>/dev/null || {
      yellow "âš ï¸  journalctl æ— æ³•è¯»å–ï¼Œå°è¯•å…¶ä»–æ–¹å¼..."
      echo "$LOG_HINT"
    }
  else
    yellow "âš ï¸  ç³»ç»Ÿæ—  journalctl"
    echo "$LOG_HINT"
  fi
}

# æŸ¥çœ‹é…ç½®
config_view() {
  if [[ -f "$CFG" ]]; then
    bold ">>> é…ç½®æ–‡ä»¶ (å‰ 200 è¡Œ)"
    echo
    if has_cmd jq; then
      jq . "$CFG" 2>/dev/null | head -200 || cat "$CFG" | head -200
    else
      cat "$CFG" | head -200
    fi
  else
    red "âœ— é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CFG"
  fi
}

# å¤‡ä»½é…ç½®
config_backup() {
  if [[ -f "$CFG" ]]; then
    local bk="${CFG}.manual.$(date +%Y%m%d_%H%M%S)"
    cp "$CFG" "$bk"
    green "âœ“ å·²å¤‡ä»½åˆ°: $bk"
  else
    red "âœ— é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CFG"
  fi
}

# ç¼–è¾‘é…ç½®
config_edit() {
  if [[ ! -f "$CFG" ]]; then
    red "âœ— é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CFG"
    return
  fi
  
  # å…ˆå¤‡ä»½
  local bk="${CFG}.before_edit.$(date +%Y%m%d_%H%M%S)"
  cp "$CFG" "$bk"
  yellow "âœ“ å·²è‡ªåŠ¨å¤‡ä»½åˆ°: $bk"
  
  # ç¼–è¾‘
  if has_cmd nano; then
    nano "$CFG"
  elif has_cmd vi; then
    vi "$CFG"
  else
    red "âœ— æœªæ‰¾åˆ°ç¼–è¾‘å™¨ (nano/vi)"
    return
  fi
  
  # éªŒè¯ JSON
  if has_cmd jq; then
    if jq empty "$CFG" 2>/dev/null; then
      green "âœ“ JSON æ ¼å¼æ­£ç¡®"
      read -r -p "æ˜¯å¦é‡å¯ Gateway ä½¿é…ç½®ç”Ÿæ•ˆ? (y/N): " confirm
      if [[ "${confirm,,}" == "y" ]]; then
        oc_restart
      fi
    else
      red "âœ— JSON æ ¼å¼é”™è¯¯ï¼å·²ä¿ç•™å¤‡ä»½: $bk"
      read -r -p "æ˜¯å¦æ¢å¤å¤‡ä»½? (y/N): " restore
      if [[ "${restore,,}" == "y" ]]; then
        cp "$bk" "$CFG"
        green "âœ“ å·²æ¢å¤å¤‡ä»½"
      fi
    fi
  else
    yellow "âš ï¸  æœªå®‰è£… jqï¼Œæ— æ³•éªŒè¯ JSON æ ¼å¼"
  fi
}

# API æ¨¡å‹æŸ¥è¯¢
api_model_checker_ui() {
  bold "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  bold "â•‘        ğŸ” API æ¨¡å‹æŸ¥è¯¢å·¥å…· ğŸ”         â•‘"
  bold "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo
  read -r -p "Base URL (å¦‚ https://kfc-api.sxxe.net/v1): " base
  read -r -p "API Key: " key
  
  if [[ -z "$base" || -z "$key" ]]; then
    red "âœ— Base URL å’Œ API Key ä¸èƒ½ä¸ºç©º"
    return
  fi
  
  echo
  yellow "ğŸ” æŸ¥è¯¢ä¸­..."
  
  if ! has_cmd curl; then
    red "âœ— ç¼ºå°‘ curl å‘½ä»¤"
    return
  fi
  
  if ! has_cmd jq; then
    red "âœ— ç¼ºå°‘ jq å‘½ä»¤"
    return
  fi
  
  local resp
  resp="$(curl -s "${base%/}/models" -H "Authorization: Bearer ${key}" 2>&1)"
  
  if echo "$resp" | jq -e '.data' >/dev/null 2>&1; then
    green "âœ“ æ”¯æŒçš„æ¨¡å‹ï¼š"
    echo
    echo "$resp" | jq -r '.data[]?.id' | nl -w3 -s'. ' || echo "$resp"
  else
    red "âœ— æŸ¥è¯¢å¤±è´¥æˆ–è¿”å›æ ¼å¼å¼‚å¸¸"
    echo "åŸå§‹å“åº”:"
    echo "$resp"
  fi
}

# å®‰è£…å¿«æ·å‘½ä»¤
install_shortcut() {
  local target="/usr/local/bin/claw22"
  
  if [[ -f "$target" ]]; then
    yellow "âš ï¸  å¿«æ·å‘½ä»¤å·²å­˜åœ¨: $target"
    read -r -p "æ˜¯å¦è¦†ç›–? (y/N): " confirm
    [[ "${confirm,,}" != "y" ]] && return
  fi
  
  if [[ "$(id -u)" -ne 0 ]]; then
    yellow "ğŸ” éœ€è¦ sudo æƒé™å®‰è£…åˆ° ${target}"
    sudo cp "$0" "$target" && sudo chmod +x "$target"
  else
    cp "$0" "$target" && chmod +x "$target"
  fi
  
  green "âœ“ å·²å®‰è£…å¿«æ·å‘½ä»¤: claw22"
  echo "ç°åœ¨å¯ä»¥ç›´æ¥è¿è¡Œ: claw22"
}

# ä¸»èœå•
main_menu() {
  while true; do
    show_header
    
    # èœå•é€‰é¡¹ï¼ˆå¸¦å›¾æ ‡ï¼‰
    cat <<'EOF'
  ğŸ“Š  1) çŠ¶æ€æ€»è§ˆ
  â–¶ï¸  2) å¯åŠ¨ Gateway
  â¸ï¸  3) åœæ­¢ Gateway
  ğŸ”„  4) é‡å¯ Gateway
  ğŸ”§  5) å¼ºåˆ¶é‡å¯ (æ¸…ç†è¿›ç¨‹+ç«¯å£)
  ğŸš‘  6) ä¸€é”®æ€¥æ•‘ (stopâ†’æ¸…ç†â†’startâ†’éªŒè¯)
  ğŸ“œ  7) æŸ¥çœ‹æ—¥å¿— (æœ€è¿‘100è¡Œ)
  ğŸ“„  8) æŸ¥çœ‹é…ç½® (å‰200è¡Œ)
  âœï¸  9) ç¼–è¾‘é…ç½® (è‡ªåŠ¨å¤‡ä»½+éªŒè¯)
  ğŸ’¾ 10) æ‰‹åŠ¨å¤‡ä»½é…ç½®
  ğŸ” 11) API æ¨¡å‹æŸ¥è¯¢
  ğŸ“¦ 12) å®‰è£…å¿«æ·å‘½ä»¤ (/usr/local/bin/claw22)
  ğŸšª  0) é€€å‡º

EOF
    cyan "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    read -r -p "$(bold 'è¯·é€‰æ‹© [0-12]: ')" choice
    echo
    
    case "${choice:-}" in
      1) oc_status; press_enter ;;
      2) oc_start; press_enter ;;
      3) oc_stop; press_enter ;;
      4) oc_restart; press_enter ;;
      5) gateway_force_restart; press_enter ;;
      6) gateway_rescue; press_enter ;;
      7) show_logs; press_enter ;;
      8) config_view; press_enter ;;
      9) config_edit; press_enter ;;
      10) config_backup; press_enter ;;
      11) api_model_checker_ui; press_enter ;;
      12) install_shortcut; press_enter ;;
      0) green "ğŸ‘‹ å†è§ï¼"; exit 0 ;;
      *) red "âœ— æ— æ•ˆé€‰é¡¹"; press_enter ;;
    esac
  done
}

# è¿è¡Œä¸»èœå•
main_menu
