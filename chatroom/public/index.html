<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸´æ—¶äº‘èŠå¤©å®¤</title>
  <style>
    :root { --bg:#0f1115; --card:#151922; --border:#242a36; --muted:#9aa4b2; --primary:#3a7bd5; --bubble:#252b36; --text:#e6e6e6; }
    body { margin:0; background:#0f1115; background:var(--bg); color:#e6e6e6; color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    .layout { display:grid; grid-template-columns: 1fr 220px; gap:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .side { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; }
    .side h3 { margin:0 0 8px 0; font-size:15px; }
    .tool-link { display:block; padding:7px 9px; border-radius:10px; background:#1f2430; color:#cbd5e1; text-decoration:none; margin:6px 0; font-size:14px; }
    .side small { color:var(--muted); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .color-wrap { margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .color-tip { font-size:12px; color:var(--muted); }
    .color-picker { display:none; gap:8px; flex-wrap:wrap; align-items:center; }
    .color-picker.open { display:flex; }
    .color-dot { width:22px; height:22px; border-radius:50%; border:2px solid #2a3040; padding:0; background:#999; cursor:pointer; }
    .color-dot.active { border-color:#ffffff; box-shadow:0 0 0 2px rgba(255,255,255,.2); }
    input, select, textarea, button { font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid #2a3040; background:#0f1115; color:#e6e6e6; }
    button { cursor:pointer; background:var(--primary); border:none; color:#fff; }
    .chat { height: 440px; overflow:auto; background:#0b0d12; border:1px solid var(--border); border-radius:12px; padding:14px; margin-top:12px; }
    .msgRow { display:flex; margin:10px 0; }
    .msgRow.me { justify-content:flex-end; }
    .bubble { display:inline-block; padding:10px 14px; border-radius:18px; max-width:72%; word-wrap:break-word; }
    .me .bubble { background:rgba(58,123,213,.65); color:#fff; border-bottom-right-radius:6px; }
    .other .bubble { background:rgba(45,53,66,.7); border-bottom-left-radius:6px; }
    .name { font-weight:600; margin-bottom:6px; display:flex; align-items:center; gap:8px; }
    .name-badge { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .time { color:#6b7280; font-size:12px; margin-left:6px; }
    .sys { color:#8aa0ff; font-size:14px; text-align:center; margin:6px 0; }
    .hint { color:var(--muted); font-size: 13px; margin-top:10px; }
    .emoji { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .emoji button { background:#1f2430; border:1px solid #2a3040; padding:6px 8px; font-size:18px; }
    textarea { min-height: 54px; max-height: 160px; resize: none; line-height: 1.5; width:100%; }
    .footer { margin-top: 10px; display:flex; gap:10px; align-items:flex-end; }

    code { background:#0c0f16; border:1px solid #2a3040; padding:2px 4px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
    pre { background:#0c0f16; border:1px solid #2a3040; padding:12px; border-radius:12px; overflow:hidden; position:relative; margin:8px 0; }
    pre.collapsed { max-height: 140px; }
    pre .code-wrap { max-height: 140px; overflow:hidden; }
    pre.expanded .code-wrap { max-height:none; }
    pre .code-wrap code { display:block; white-space:pre-wrap; word-break:break-word; }
    .code-actions { display:flex; gap:6px; position:absolute; right:8px; top:8px; }
    .copy, .expand { font-size:12px; background:#202534; color:#cbd5e1; border:1px solid #2b3142; padding:4px 6px; border-radius:6px; }

    .replyBox { display:none; align-items:center; gap:10px; background:#10131a; border:1px solid #2a3040; border-radius:10px; padding:8px 10px; margin-top:8px; }
    .replyBox .mini { font-weight:600; }
    .replyBox .close { margin-left:auto; background:#1f2430; }

    .imgMsg { max-width: 220px; border-radius:10px; border:1px solid var(--border); cursor:zoom-in; }
    .member-list { margin-top:12px; border-top:1px dashed var(--border); padding-top:10px; }
    .member { display:flex; align-items:center; gap:8px; font-size:14px; margin:6px 0; }
    .member .dot { width:8px; height:8px; border-radius:50%; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal img { max-width:90vw; max-height:90vh; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.5); }
    @media (max-width: 600px) {
      .wrap { padding: 12px; }
      .layout { grid-template-columns: 1fr; }
      .side { order:2; }
      .card { order:1; }
      .chat { height: 360px; }
      .row input, .row select, .row button { flex: 1 1 100%; }
    }
  
/* ä¼˜åŒ–åçš„æ ·å¼å¢å¼º */

/* æ¸å˜èƒŒæ™¯ */
body {
  background: linear-gradient(135deg, #0f1115 0%, #1a1d28 100%);
  min-height: 100vh;
}

/* æ ‡é¢˜ç¾åŒ– */
h2 {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 28px;
  font-weight: 700;
  margin: 20px 0;
  text-align: center;
}

/* å¡ç‰‡é˜´å½±æ•ˆæœ */
.card, .side {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
}

/* æŒ‰é’®ä¼˜åŒ– */
button {
  transition: all 0.2s;
  font-weight: 500;
}

button:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(58, 123, 213, 0.4);
}

button:active:not(:disabled) {
  transform: translateY(0);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ */
input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.1);
}

/* æ¶ˆæ¯æ°”æ³¡åŠ¨ç”» */
.msgRow {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* åœ¨çº¿çŠ¶æ€æŒ‡ç¤º */
.member .dot {
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* åŠ è½½çŠ¶æ€ */
.loading {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* å·¥å…·é“¾æ¥æ‚¬åœæ•ˆæœ */
.tool-link {
  transition: all 0.2s;
}

.tool-link:hover {
  background: #2a3040;
  transform: translateX(4px);
}

/* å›¾ç‰‡é¢„è§ˆä¼˜åŒ– */
.imgMsg {
  transition: transform 0.2s;
}

.imgMsg:hover {
  transform: scale(1.05);
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
.chat::-webkit-scrollbar {
  width: 8px;
}

.chat::-webkit-scrollbar-track {
  background: #0b0d12;
  border-radius: 4px;
}

.chat::-webkit-scrollbar-thumb {
  background: #2a3040;
  border-radius: 4px;
}

.chat::-webkit-scrollbar-thumb:hover {
  background: #3a4050;
}

/* å›å¤æ¡†ä¼˜åŒ– */
.replyBox {
  animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ç³»ç»Ÿæ¶ˆæ¯ä¼˜åŒ– */
.sys {
  animation: fadeIn 0.4s ease-out;
  padding: 8px 16px;
  background: rgba(138, 160, 255, 0.1);
  border-radius: 20px;
  display: inline-block;
  margin: 8px auto;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* é¢œè‰²é€‰æ‹©å™¨ä¼˜åŒ– */
.color-dot {
  transition: all 0.2s;
}

.color-dot:hover {
  transform: scale(1.2);
}

/* Emoji æŒ‰é’®ä¼˜åŒ– */
.emoji button:hover {
  background: #2a3040;
  transform: scale(1.1);
}

/* æç¤ºæ–‡æœ¬ä¼˜åŒ– */
.hint {
  padding: 8px 12px;
  background: rgba(154, 164, 178, 0.1);
  border-radius: 8px;
  border-left: 3px solid var(--primary);
}

/* æ¨¡æ€æ¡†ä¼˜åŒ– */
.modal {
  backdrop-filter: blur(8px);
}

.modal img {
  animation: zoomIn 0.3s ease-out;
}

@keyframes zoomIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* è¿æ¥çŠ¶æ€æŒ‡ç¤º */
.status-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
}

.status-connected {
  background: #00b894;
  box-shadow: 0 0 8px rgba(0, 184, 148, 0.6);
}

.status-disconnected {
  background: #d63031;
}

.status-connecting {
  background: #fdcb6e;
  animation: pulse 1s ease-in-out infinite;
}

  

    .video-msg { max-width:100%; }
    .videoMsg { max-width:100%; max-height:400px; border-radius:10px; background:#000; }
    .video-info { display:flex; justify-content:space-between; margin-top:8px; font-size:13px; }
    .video-name { font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; }
    .video-size { color:var(--muted); margin-left:8px; white-space:nowrap; }
    .file-msg { display:flex; align-items:center; gap:12px; padding:8px; background:rgba(255,255,255,0.05); border-radius:10px; }
    .file-icon { font-size:32px; }
    .file-info { flex:1; min-width:0; }
    .file-name { font-weight:600; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .file-size { font-size:12px; color:var(--muted); margin-top:2px; }
    .file-download { padding:6px 12px; background:var(--primary); color:#fff; border-radius:8px; text-decoration:none; font-size:13px; white-space:nowrap; }
    .file-download:hover { opacity:0.9; }
  </style>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¬</text></svg>">
  <meta name="description" content="è½»é‡çº§ä¸´æ—¶èŠå¤©å®¤ï¼Œæ”¯æŒå®æ—¶é€šè®¯å’Œæ–‡ä»¶åˆ†äº«">
  <meta name="keywords" content="ä¸´æ—¶èŠå¤©å®¤,åœ¨çº¿èŠå¤©,æ–‡ä»¶åˆ†äº«">
</head>
<body>
  <div class="wrap">
    <h2><span id="statusIndicator" class="status-indicator status-disconnected"></span>ä¸´æ—¶äº‘èŠå¤©å®¤</h2>
    <div class="layout">
      <div class="card">
        <div class="row">
          <input id="name" placeholder="ä½ çš„æ˜µç§°" />
          <input id="room" placeholder="æˆ¿é—´å·ï¼ˆéšä¾¿å¡«ä¸€ä¸ªï¼‰" />
          <input id="duration" placeholder="æ—¶é•¿(å°æ—¶, 1-72)" />
          <div class="color-wrap">
            <button id="colorToggle" class="uploadBtn">æ˜µç§°é¢œè‰²</button>
            <span class="color-tip">(å¯¹å¤–å±•ç¤ºé¢œè‰²)</span>
          </div>
          <div id="colorPicker" class="color-picker"></div>
          <input id="color" type="hidden" value="#2f80ed" />
          <button id="join"><span id="joinText">è¿›å…¥æˆ¿é—´</span></button>
        </div>
        <div class="hint">åˆ†äº«é“¾æ¥ï¼š<span id="share">â€”</span> <button id="copy">å¤åˆ¶</button></div>
        <div class="hint" id="roomHint">æç¤ºï¼šæˆ¿é—´æ˜¯ä¸´æ—¶çš„ï¼Œä¸å­˜æ•°æ®åº“ï¼Œé‡å¯æœåŠ¡åä¼šæ¸…ç©ºã€‚</div>

        <div id="chat" class="chat"></div>

        <div class="emoji" id="emojiBar"></div>

        <div class="replyBox" id="replyBox">
          <div>å›å¤ <span class="mini" id="replyName"></span>ï¼š</div>
          <div id="replyText" style="color:#cbd5e1; font-size:13px;"></div>
          <button class="close" id="replyClose">å–æ¶ˆ</button>
        </div>

        <div class="footer">
          <textarea id="text" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1;"></textarea>
          <input id="file" type="file" style="display:none" />
          <button id="upload" class="uploadBtn">æ–‡ä»¶</button>
          <button id="send">å‘é€</button>
        </div>
      </div>

      <aside class="side" id="side">
        <div class="row" style="justify-content:space-between;">
          <h3>å·¥å…·ç®±</h3>
        </div>
        <a class="tool-link" href="https://image.dooo.ng/" target="_blank">å›¾åºŠ / å›¾ç‰‡å¤–é“¾</a>
        <a class="tool-link" href="https://www.sodatool.com/tool/file-transfer" target="_blank">ä¸´æ—¶æ–‡ä»¶ç®± (Sodatool)</a>
        <a class="tool-link" href="https://lingdaima.com/file/" target="_blank">ä¸´æ—¶æ–‡ä»¶ç®± (çµä»£ç )</a>
        <a class="tool-link" href="https://webnote.cc/" target="_blank">äº‘å‰ªè´´æ¿</a>
        <small>æç¤ºï¼šå·¥å…·ç®±ä¸ä¼šå ç”¨ä½ çš„æœåŠ¡å™¨èµ„æºã€‚</small>

        <div class="member-list" id="memberList">
          <h3>æˆå‘˜</h3>
          <div id="members"></div>
        </div>
      </aside>
    </div>
  </div>

  <div id="modal" class="modal"><img id="modalImg" src="" alt="preview" /></div>

<script>
  const chat = document.getElementById('chat');
  const nameInput = document.getElementById('name');
  const roomInput = document.getElementById('room');
  const durationInput = document.getElementById('duration');
  const colorSelect = document.getElementById('color');
  const colorPicker = document.getElementById('colorPicker');
  const colorToggle = document.getElementById('colorToggle');
  const textInput = document.getElementById('text');
  const joinBtn = document.getElementById('join');
  const sendBtn = document.getElementById('send');
  const share = document.getElementById('share');
  const copyBtn = document.getElementById('copy');
  const emojiBar = document.getElementById('emojiBar');
  const roomHint = document.getElementById('roomHint');
  const replyBox = document.getElementById('replyBox');
  const replyName = document.getElementById('replyName');
  const replyText = document.getElementById('replyText');
  const replyClose = document.getElementById('replyClose');
  const fileInput = document.getElementById('file');
  const uploadBtn = document.getElementById('upload');
  const modal = document.getElementById('modal');
  const modalImg = document.getElementById('modalImg');
  const membersEl = document.getElementById('members');

  let ws;
  let currentName = 'åŒ¿å';
  let currentRoom = 'lobby';
  let currentColor = '#2f80ed';
  let replyTo = null;
  let roomPassword = '';

  const colorPalette = ['#2f80ed','#6c5ce7','#00b894','#e17055','#0984e3','#d63031','#fdcb6e','#00cec9','#636e72','#e84393'];
  colorPalette.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'color-dot' + (c === '#2f80ed' ? ' active' : '');
    btn.style.background = c;
    btn.title = c;
    btn.onclick = () => {
      currentColor = c;
      colorSelect.value = c;
      document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
      btn.classList.add('active');
    };
    colorPicker.appendChild(btn);
  });
  colorToggle.onclick = () => colorPicker.classList.toggle('open');

  const emojis = ['ğŸ˜€','ğŸ˜‚','ğŸ¥²','ğŸ˜','ğŸ¤”','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ™','ğŸ‰','ğŸ”¥','ğŸ’¡','ğŸ’¬','ğŸ’¯'];
  emojis.forEach(e => { const b = document.createElement('button'); b.textContent = e; b.onclick = () => { textInput.value += e; autoGrow(); textInput.focus(); }; emojiBar.appendChild(b); });

  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function renderMarkdown(s){
    let t = escapeHtml(s);
    const blocks = [];
    t = t.replace(/```([\s\S]*?)```/g, (m, code) => { const id = blocks.length; blocks.push(code); return `@@CODE${id}@@`; });
    t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
    t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/\*([^*]+)\*\*/g, '<em>$1</em>');
    t = t.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    t = t.replace(/\n/g, '<br/>');
    t = t.replace(/@@CODE(\d+)@@/g, (m, id) => {
      const safe = escapeHtml(blocks[Number(id)]?.trim() || '');
      return `<pre class="collapsed"><div class="code-actions"><button class="copy" onclick="copyBlock(this)">å¤åˆ¶</button><button class="expand" onclick="toggleCode(this)">å±•å¼€</button></div><div class="code-wrap"><code>${safe}</code></div></pre>`;
    });
    return t;
  }

  function addSystem(text, ts) {
    const div = document.createElement('div');
    div.className = 'sys';
    div.innerHTML = `ğŸ”” ${text} <span class="time">${new Date(ts).toLocaleTimeString()}</span>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
  }

  function addChat(msg) {
    // å¦‚æœä¸æ˜¯è‡ªå·±çš„æ¶ˆæ¯ä¸”é¡µé¢ä¸å¯è§ï¼Œæ˜¾ç¤ºé€šçŸ¥
    if (msg.name !== currentName && document.hidden) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(`${msg.name} è¯´:`, {
          body: msg.text.slice(0, 100),
          icon: '/favicon.ico',
          tag: 'chatroom-msg'
        });
      }
    }
    
    const row = document.createElement('div');
    row.className = 'msgRow ' + (msg.name === currentName ? 'me' : 'other');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    const replyHtml = msg.replyTo ? `<div class="reply">å›å¤ ${escapeHtml(msg.replyTo.name)}ï¼š${escapeHtml(msg.replyTo.text)}</div>` : '';
    const badge = `<span class="name-badge" style="background:${msg.color || '#2f80ed'}"></span>`;
    if (msg.name !== currentName) {
      bubble.innerHTML = `${replyHtml}<span class="name">${badge}${escapeHtml(msg.name)}</span>${renderMarkdown(msg.text)} <span class="time">${new Date(msg.ts).toLocaleTimeString()}</span>`;
    } else {
      bubble.innerHTML = `${replyHtml}${renderMarkdown(msg.text)} <span class="time">${new Date(msg.ts).toLocaleTimeString()}</span>`;
    }
    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;

    row.ondblclick = () => setReply(msg.name, msg.text);
    let startX = 0;
    row.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; });
    row.addEventListener('touchend', (e) => { const endX = e.changedTouches[0].clientX; if (startX - endX > 60) setReply(msg.name, msg.text); });
  }

  function addImage(msg){
    const row = document.createElement('div');
    row.className = 'msgRow ' + (msg.name === currentName ? 'me' : 'other');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    const img = `<img class="imgMsg" src="${msg.url}" alt="${escapeHtml(msg.original||'image')}" data-src="${msg.url}" />`;
    const badge = `<span class="name-badge" style="background:${msg.color || '#2f80ed'}"></span>`;
    if (msg.name !== currentName) {
      bubble.innerHTML = `<span class="name">${badge}${escapeHtml(msg.name)}</span>${img}<div style="margin-top:6px;"><a href="${msg.url}" target="_blank" download>æŸ¥çœ‹åŸå›¾</a></div>`;
    } else {
      bubble.innerHTML = `${img}<div style="margin-top:6px;"><a href="${msg.url}" target="_blank" download>æŸ¥çœ‹åŸå›¾</a></div>`;
    }
    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
    const imgEl = row.querySelector('img');
    if (imgEl) imgEl.onclick = () => { modalImg.src = imgEl.dataset.src; modal.style.display = 'flex'; };
  }


  function addFile(msg){
    const row = document.createElement('div');
    row.className = 'msgRow ' + (msg.name === currentName ? 'me' : 'other');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    
    const fileIcon = getFileIcon(msg.mime, msg.original);
    const fileHtml = `
      <div class="file-msg">
        <div class="file-icon">${fileIcon}</div>
        <div class="file-info">
          <div class="file-name">${escapeHtml(msg.original)}</div>
          <div class="file-size">${msg.sizeFormatted || ''}</div>
        </div>
        <a href="${msg.url}" class="file-download" download="${escapeHtml(msg.original)}" target="_blank">ä¸‹è½½</a>
      </div>
    `;
    
    const badge = `<span class="name-badge" style="background:${msg.color || '#2f80ed'}"></span>`;
    if (msg.name !== currentName) {
      bubble.innerHTML = `<span class="name">${badge}${escapeHtml(msg.name)}</span>${fileHtml}`;
    } else {
      bubble.innerHTML = fileHtml;
    }
    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }


  function addVideo(msg){
    const row = document.createElement('div');
    row.className = 'msgRow ' + (msg.name === currentName ? 'me' : 'other');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    
    const videoHtml = `
      <div class="video-msg">
        <video class="videoMsg" controls preload="metadata">
          <source src="${msg.url}" type="${msg.mime}">
          æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
        </video>
        <div class="video-info">
          <span class="video-name">${escapeHtml(msg.original)}</span>
          <span class="video-size">${msg.sizeFormatted || ''}</span>
        </div>
      </div>
    `;
    
    const badge = `<span class="name-badge" style="background:${msg.color || '#2f80ed'}"></span>`;
    if (msg.name !== currentName) {
      bubble.innerHTML = `<span class="name">${badge}${escapeHtml(msg.name)}</span>${videoHtml}`;
    } else {
      bubble.innerHTML = videoHtml;
    }
    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function getFileIcon(mime, filename) {
    if (/^image\//i.test(mime)) return 'ğŸ–¼ï¸';
    if (/^video\//i.test(mime)) return 'ğŸ¬';
    if (/^audio\//i.test(mime)) return 'ğŸµ';
    if (/pdf$/i.test(filename)) return 'ğŸ“„';
    if (/\.(doc|docx)$/i.test(filename)) return 'ğŸ“';
    if (/\.(xls|xlsx)$/i.test(filename)) return 'ğŸ“Š';
    if (/\.(ppt|pptx)$/i.test(filename)) return 'ğŸ“½ï¸';
    if (/\.(zip|rar|7z|tar|gz)$/i.test(filename)) return 'ğŸ“¦';
    if (/\.(txt|md|log)$/i.test(filename)) return 'ğŸ“ƒ';
    if (/\.(json|xml|csv)$/i.test(filename)) return 'ğŸ“‹';
    return 'ğŸ“';
  }

  function setReply(name, text){
    replyTo = { name, text };
    replyName.textContent = name;
    replyText.textContent = text.length > 80 ? text.slice(0,80) + 'â€¦' : text;
    replyBox.style.display = 'flex';
  }

  replyClose.onclick = () => { replyTo = null; replyBox.style.display = 'none'; };
  modal.onclick = () => { modal.style.display = 'none'; modalImg.src=''; };

  function updateShareLink() { share.textContent = `${location.origin}/?room=${encodeURIComponent(currentRoom)}`; }

  function getDeviceId(){
    let id = localStorage.getItem('device_id');
    if (!id) {
      id = 'd_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem('device_id', id);
    }
    return id;
  }

  function connect() {
    const statusIndicator = document.getElementById('statusIndicator');
    const joinBtn = document.getElementById('join');
    const joinText = document.getElementById('joinText');
    
    statusIndicator.className = 'status-indicator status-connecting';
    joinBtn.disabled = true;
    joinText.innerHTML = '<span class="loading"></span> è¿æ¥ä¸­...';
    
    currentName = nameInput.value.trim() || 'åŒ¿å';
    currentRoom = roomInput.value.trim() || 'lobby';
    currentColor = colorSelect.value || '#2f80ed';
    const pass = roomPassword || '';
    const durationHours = durationInput.value.trim();

    const deviceId = getDeviceId();
    const wsUrl = (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/?room=' + encodeURIComponent(currentRoom) + '&name=' + encodeURIComponent(currentName) + '&pass=' + encodeURIComponent(pass) + '&durationHours=' + encodeURIComponent(durationHours) + '&color=' + encodeURIComponent(currentColor) + '&device=' + encodeURIComponent(deviceId);
    ws = new WebSocket(wsUrl);

    ws.onopen = () => { 
      statusIndicator.className = 'status-indicator status-connected';
      joinBtn.disabled = false;
      joinText.textContent = 'å·²è¿æ¥';
      setTimeout(() => joinText.textContent = 'è¿›å…¥æˆ¿é—´', 2000);
      addSystem(`å·²è¿›å…¥æˆ¿é—´ï¼š${currentRoom}`, Date.now()); 
      updateShareLink(); 
    };

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.type === 'system') addSystem(data.text, data.ts);
      if (data.type === 'admin_help') addSystem(data.text, data.ts);
      if (data.type === 'chat') addChat(data);
      if (data.type === 'image') addImage(data);
      if (data.type === 'video') addVideo(data);
      if (data.type === 'file') addFile(data);
      if (data.type === 'members') {
        membersEl.innerHTML = '';
        data.members.forEach(m => {
          const div = document.createElement('div');
          div.className = 'member';
          div.innerHTML = `<span class="dot" style="background:${m.color}"></span>${escapeHtml(m.name)}`;
          membersEl.appendChild(div);
        });
      }
      if (data.type === 'set_pass') {
        const p = prompt('è®¾ç½®æˆ¿é—´å¯†ç ï¼ˆå¯ç•™ç©ºè¡¨ç¤ºä¸åŠ å¯†ï¼‰');
        roomPassword = (p || '').trim();
        if (roomPassword) ws.send(JSON.stringify({ type:'chat', text: `/pass ${roomPassword}` }));
        else ws.send(JSON.stringify({ type:'chat', text: `/pass` }));
      }
      if (data.type === 'clear') chat.innerHTML = '';
      if (data.type === 'room_info' && data.expiresAt) { const left = Math.max(0, data.expiresAt - Date.now()); roomHint.textContent = `æœ¬æˆ¿é—´å°†äº ${new Date(data.expiresAt).toLocaleString()} è¿‡æœŸï¼ˆçº¦ ${Math.ceil(left/60000)} åˆ†é’Ÿï¼‰`; }
      if (data.type === 'kicked') addSystem(data.text, data.ts);
      if (data.type === 'error') {
        if (data.code === 'wrong_password') {
          const p = prompt('æˆ¿é—´æœ‰å¯†ç ï¼Œè¯·è¾“å…¥ï¼š');
          roomPassword = (p || '').trim();
          if (roomPassword) { if (ws) ws.close(); connect(); }
          return;
        }
        addSystem(data.message || 'é”™è¯¯', data.ts);
      }
    };

    ws.onclose = () => {
      statusIndicator.className = 'status-indicator status-disconnected';
      joinBtn.disabled = false;
      joinText.textContent = 'è¿›å…¥æˆ¿é—´';
      addSystem('è¿æ¥å·²æ–­å¼€', Date.now());
    };
  }

  joinBtn.onclick = () => {
    if (!currentRoom || currentRoom !== roomInput.value.trim()) roomPassword = '';
    connect();
  };
  sendBtn.onclick = () => {
    if (!ws || ws.readyState !== 1) return;
    const val = textInput.value;
    if (!val.trim()) return;
    ws.send(JSON.stringify({ type: 'chat', text: val, replyTo }));
    textInput.value = '';
    autoGrow();
    replyTo = null;
    replyBox.style.display = 'none';
  };

  textInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (!isMobile && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    }
  });
  textInput.addEventListener('input', () => autoGrow());
  function autoGrow(){ textInput.style.height = 'auto'; textInput.style.height = Math.min(textInput.scrollHeight, 160) + 'px'; }
  autoGrow();

  copyBtn.onclick = async () => { if (!share.textContent || share.textContent === 'â€”') return; try { await navigator.clipboard.writeText(share.textContent); addSystem('é“¾æ¥å·²å¤åˆ¶', Date.now()); } catch(e) {} };

  uploadBtn.onclick = () => fileInput.click();
  fileInput.onchange = async () => { if (!fileInput.files || !fileInput.files[0]) return; await uploadImage(fileInput.files[0]); fileInput.value = ''; };
  textInput.addEventListener('paste', async (e) => {
    const items = e.clipboardData?.items || [];
    for (const it of items) { if (it.type.startsWith('image/')) { const file = it.getAsFile(); if (file) await uploadImage(file); } }
  });
  document.addEventListener('dragover', (e) => e.preventDefault());
  document.addEventListener('drop', async (e) => { e.preventDefault(); const files = e.dataTransfer?.files || []; if (files.length) await uploadImage(files[0]); });

  function uploadImage(file){
    const maxSize = 200 * 1024 * 1024; // 200MB
    if (file.size > maxSize) {
      addSystem('æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§ 200MB', Date.now());
      return;
    }
    
    const uploadMsg = addSystem(`${currentName} æ­£åœ¨ä¸Šä¼ ... 0%`, Date.now());
    
    const form = new FormData();
    form.append('file', file);
    const qs = `room=${encodeURIComponent(currentRoom)}&name=${encodeURIComponent(currentName)}&color=${encodeURIComponent(currentColor)}`;
    
    const xhr = new XMLHttpRequest();
    
    // ä¸Šä¼ è¿›åº¦
    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        if (uploadMsg && uploadMsg.textContent) {
          uploadMsg.textContent = `ğŸ”” ${currentName} æ­£åœ¨ä¸Šä¼ ... ${percent}%`;
        }
      }
    });
    
    // å®Œæˆ
    xhr.addEventListener('load', () => {
      if (uploadMsg) uploadMsg.remove();
      if (xhr.status === 200) {
        // ä¸Šä¼ æˆåŠŸï¼ŒæœåŠ¡å™¨ä¼šå¹¿æ’­æ¶ˆæ¯
      } else {
        try {
          const data = JSON.parse(xhr.responseText);
          addSystem(`ä¸Šä¼ å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, Date.now());
        } catch (e) {
          addSystem('ä¸Šä¼ å¤±è´¥', Date.now());
        }
      }
    });
    
    // é”™è¯¯
    xhr.addEventListener('error', () => {
      if (uploadMsg) uploadMsg.remove();
      addSystem('ä¸Šä¼ å¤±è´¥', Date.now());
    });
    
    // è¶…æ—¶
    xhr.addEventListener('timeout', () => {
      if (uploadMsg) uploadMsg.remove();
      addSystem('ä¸Šä¼ è¶…æ—¶', Date.now());
    });
    
    xhr.timeout = 120000; // 2åˆ†é’Ÿè¶…æ—¶
    xhr.open('POST', `/upload?${qs}`);
    xhr.send(form);
  }

  window.copyBlock = (btn) => {
    const code = btn.closest('pre')?.querySelector('code')?.innerText || '';
    if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(code); }
    else { const ta = document.createElement('textarea'); ta.value = code; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); } catch(e) {} ta.remove(); }
    btn.textContent = 'å·²å¤åˆ¶'; setTimeout(() => btn.textContent = 'å¤åˆ¶', 1200);
  };
  window.toggleCode = (btn) => {
    const pre = btn.closest('pre'); if (!pre) return; const expanded = pre.classList.toggle('expanded'); pre.classList.toggle('collapsed', !expanded); btn.textContent = expanded ? 'æ”¶èµ·' : 'å±•å¼€';
  };

  // è¯·æ±‚é€šçŸ¥æƒé™
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  // URL å‚æ•°è‡ªåŠ¨åŠ å…¥
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('room')) {
    roomInput.value = urlParams.get('room');
    if (urlParams.get('name')) nameInput.value = urlParams.get('name');
    // è‡ªåŠ¨è¿æ¥
    setTimeout(() => joinBtn.click(), 500);
  }
</script>
</body>
</html>
